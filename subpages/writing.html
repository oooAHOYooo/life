<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Writing Projects - LifeOS</title>
        <link rel="stylesheet" href="../styles.css">
        <style>
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        
        /* File Modal Styles */
        .file-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .file-modal {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .file-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-modal-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }
        
        .file-modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #7f8c8d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .file-modal-close:hover {
            color: #2c3e50;
        }
        
        .file-modal-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            background: #f8f9fa;
        }
        
        .file-modal-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .file-modal-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .file-btn.download-btn {
            background: #3498db;
            color: white;
        }
        
        .file-btn.download-btn:hover {
            background: #2980b9;
        }
    </style>
    </head>
    <body>
        <div class="container">
            <a href="../index.html" class="back-link">← Back to LifeOS</a>

            <header>
                <h1>Writing Projects</h1>
                <p>Active writing projects and creative works in progress</p>
            </header>

            <div id="writingList" class="writing-list">
                <!-- Writing projects will be loaded here -->
            </div>

            <div class="drafts-section">
                <h2>Writing Drafts</h2>
                <div class="drafts-table-container">
                    <table id="draftsTable" class="drafts-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Version</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Last Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="draftsTableBody">
                            <!-- Drafts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
        class WritingPage {
            constructor() {
                this.writingProjects = [];
                this.drafts = [];
                this.init();
            }

            async init() {
                await this.loadData();
                this.renderWritingProjects();
                this.renderDraftsTable();
            }

            async loadData() {
                try {
                    const [projectsResponse, draftsResponse] = await Promise.all([
                        fetch('../data/writing-projects.json'),
                        fetch('../data/writing-drafts.json')
                    ]);
                    this.writingProjects = await projectsResponse.json();
                    this.drafts = await draftsResponse.json();
                } catch (error) {
                    console.error('Error loading writing data:', error);
                    this.showError('Failed to load writing data.');
                }
            }

            renderWritingProjects() {
                const container = document.getElementById('writingList');
                
                if (this.writingProjects.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No writing projects yet</h3><p>Add some writing projects to your writing-projects.json file</p></div>';
                    return;
                }

                container.innerHTML = this.writingProjects.map((project, projectIndex) => {
                    // Get all drafts for this project
                    const projectDrafts = this.drafts.filter(draft => 
                        draft.projectId === project.title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
                    );
                    const projectId = project.title.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                    
                    return `
                        <div class="writing-folder">
                            <div class="folder-header" data-project-id="${projectId}">
                                <div class="folder-info">
                                    <h3 class="folder-title">${this.escapeHtml(project.title)}</h3>
                                    <p class="folder-description">${this.escapeHtml(project.description)}</p>
                                    <div class="folder-meta">
                                        <span class="writing-tag writing-category">${this.escapeHtml(project.category)}</span>
                                        <span class="folder-count">${projectDrafts.length} files</span>
                                    </div>
                                </div>
                                <div class="folder-toggle">▼</div>
                            </div>
                            
                            <div class="folder-content" id="folder-${projectId}" style="display: none;">
                                <div class="folder-section">
                                    <h4>All Files</h4>
                                    ${projectDrafts.length > 0 ? `
                                        <div class="file-list">
                                            ${projectDrafts.map((draft, draftIndex) => `
                                                <div class="file-item">
                                                    <div class="file-icon">${draft.fileType === 'md' ? 'MD' : 'PDF'}</div>
                                                    <div class="file-info">
                                                        <div class="file-name">${this.escapeHtml(draft.title)}</div>
                                                        <div class="file-meta">
                                                            <span class="file-version">${this.escapeHtml(draft.version)}</span>
                                                            <span class="file-type ${draft.fileType}">${draft.fileType.toUpperCase()}</span>
                                                            <span class="file-date">${this.escapeHtml(draft.lastModified)}</span>
                                                        </div>
                                                    </div>
                                                    <div class="file-actions">
                                                        <button class="file-btn view-btn" data-file-path="${this.escapeHtml(draft.filePath)}" data-file-type="${draft.fileType}">View</button>
                                                        <button class="file-btn download-btn" data-file-path="${this.escapeHtml(draft.filePath)}" data-file-name="${this.escapeHtml(draft.title)}">Download</button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="no-files">No files available</div>
                                    `}
                                </div>
                                
                                <div class="folder-section">
                                    <h4>Project Details</h4>
                                    <div class="project-details">
                                        <p class="project-notes"><strong>Notes:</strong> ${this.escapeHtml(project.notes)}</p>
                                        <p class="project-updated"><strong>Last Updated:</strong> ${this.escapeHtml(project.lastUpdated)}</p>
                                        ${project.filePath ? `<p class="project-file"><strong>Main File:</strong> ${this.escapeHtml(project.filePath)}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Attach event listeners after rendering
                this.attachEventListeners();
            }

            attachEventListeners() {
                // Folder toggle handlers
                document.querySelectorAll('.folder-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const projectId = header.getAttribute('data-project-id');
                        this.toggleFolder(projectId, e);
                    });
                });

                // View button handlers
                document.querySelectorAll('.file-btn.view-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const filePath = btn.getAttribute('data-file-path');
                        const fileType = btn.getAttribute('data-file-type');
                        this.viewFile(filePath, fileType);
                    });
                });

                // Download button handlers
                document.querySelectorAll('.file-btn.download-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const filePath = btn.getAttribute('data-file-path');
                        const fileName = btn.getAttribute('data-file-name');
                        this.downloadFile(filePath, fileName);
                    });
                });
            }

            renderDraftsTable() {
                const tbody = document.getElementById('draftsTableBody');
                
                if (this.drafts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-drafts">No drafts found</td></tr>';
                    return;
                }

                tbody.innerHTML = this.drafts.map(draft => `
                    <tr class="draft-row">
                        <td class="draft-title">${this.escapeHtml(draft.title)}</td>
                        <td class="draft-version">${this.escapeHtml(draft.version)}</td>
                        <td class="draft-type">
                            <span class="file-type-badge ${draft.fileType}">${draft.fileType.toUpperCase()}</span>
                        </td>
                        <td class="draft-status">
                            <span class="status-badge status-${draft.status.toLowerCase().replace(' ', '-')}">${this.escapeHtml(draft.status)}</span>
                        </td>
                        <td class="draft-modified">${this.escapeHtml(draft.lastModified)}</td>
                        <td class="draft-actions">
                            <button class="action-btn view-btn" onclick="this.viewDraft('${draft.id}')">View</button>
                            <button class="action-btn edit-btn" onclick="this.editDraft('${draft.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');
            }

            viewDraft(draftId) {
                const draft = this.drafts.find(d => d.id === draftId);
                if (draft) {
                    if (draft.fileType === 'pdf') {
                        window.open(draft.filePath, '_blank');
                    } else {
                        // For markdown files, we could open in a new tab or modal
                        window.open(draft.filePath, '_blank');
                    }
                }
            }

            editDraft(draftId) {
                const draft = this.drafts.find(d => d.id === draftId);
                if (draft) {
                    // For now, just open the file
                    // In a real implementation, this might open an editor
                    window.open(draft.filePath, '_blank');
                }
            }

            toggleFolder(folderId, event) {
                const folder = document.getElementById(`folder-${folderId}`);
                const header = event.target.closest('.folder-header');
                const toggle = header.querySelector('.folder-toggle');
                
                if (folder.style.display === 'none' || !folder.style.display) {
                    folder.style.display = 'block';
                    toggle.textContent = '▲';
                } else {
                    folder.style.display = 'none';
                    toggle.textContent = '▼';
                }
            }

            async viewFile(filePath, fileType) {
                if (fileType === 'pdf') {
                    // For PDFs, open in new tab
                    window.open(`../${filePath}`, '_blank');
                } else {
                    // For markdown/text files, fetch and display in modal
                    try {
                        const response = await fetch(`../${filePath}`);
                        if (!response.ok) throw new Error('Failed to load file');
                        const content = await response.text();
                        this.showFileModal(content, filePath);
                    } catch (error) {
                        console.error('Error loading file:', error);
                        alert('Failed to load file. Opening in new tab instead.');
                        window.open(`../${filePath}`, '_blank');
                    }
                }
            }

            async downloadFile(filePath, fileName) {
                try {
                    // Fetch the file content
                    const response = await fetch(`../${filePath}`);
                    if (!response.ok) throw new Error('Failed to fetch file');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    // Create a temporary link and trigger download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName || filePath.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up the object URL
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error downloading file:', error);
                    // Fallback: try direct link
                    const link = document.createElement('a');
                    link.href = `../${filePath}`;
                    link.download = fileName || filePath.split('/').pop();
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            showFileModal(content, filePath) {
                // Create modal overlay
                const modal = document.createElement('div');
                modal.className = 'file-modal-overlay';
                const fileName = filePath.split('/').pop();
                modal.innerHTML = `
                    <div class="file-modal">
                        <div class="file-modal-header">
                            <h3>${this.escapeHtml(fileName)}</h3>
                            <button class="file-modal-close">&times;</button>
                        </div>
                        <div class="file-modal-content">
                            <pre>${this.escapeHtml(content)}</pre>
                        </div>
                        <div class="file-modal-footer">
                            <button class="file-btn download-btn" data-modal-file-path="${this.escapeHtml(filePath)}" data-modal-file-name="${this.escapeHtml(fileName)}">Download</button>
                            <button class="file-btn close-modal-btn">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Close handlers
                const closeBtn = modal.querySelector('.file-modal-close');
                const closeModalBtn = modal.querySelector('.close-modal-btn');
                const closeModal = () => {
                    document.body.removeChild(modal);
                };
                closeBtn.addEventListener('click', closeModal);
                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                // Download handler
                const downloadBtn = modal.querySelector('.download-btn');
                downloadBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const modalFilePath = downloadBtn.getAttribute('data-modal-file-path');
                    const modalFileName = downloadBtn.getAttribute('data-modal-file-name');
                    this.downloadFile(modalFilePath, modalFileName);
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                const container = document.querySelector('.container');
                container.innerHTML = `
                    <div class="error-state">
                        <h2>Error</h2>
                        <p>${message}</p>
                        <button onclick="location.reload()">Reload Page</button>
                    </div>
                `;
            }
        }

        // Initialize the page when it loads
        document.addEventListener('DOMContentLoaded', () => {
            new WritingPage();
        });
    </script>
    </body>
</html>
